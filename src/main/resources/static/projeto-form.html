<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Criar Projeto - SightCut</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script>
    const sessionUserId = localStorage.getItem("sessionUserId");
    if (!sessionUserId) {
      alert("Ã‰ necessÃ¡rio efetuar o login antes de acessar o programa.");
      window.location.replace("home.html");
    }
  </script>
</head>
<body>
<header class="topbar">
  <div class="container">
    <div class="brand"><a href="index.html"><img src="/img/Prancheta 3.png" alt="SightCut" class="logo"></a></div>
    <nav class="mainnav">
      <a href="clientes.html">Gerenciar Clientes</a>
      <a href="materiais.html">Gerenciar Materiais</a>
      <a href="projetos.html" class="active">Projetos</a>
    </nav>
    <div class="user">
    </div>
  </div>
</header>

<div class="container page">
  <aside class="sidebar">
    <h2>Projetos <span class="icon">ðŸ“‹</span></h2>
    <a class="btn white active" href="projeto-form.html">Criar Projeto âŠ•</a>
  </aside>

  <section class="content">
    <div class="panel form-panel">
      <h1 id="page-title">Novo Projeto</h1>

      <input type="text" id="titulo" placeholder="TÃ­tulo do Projeto" required>
      <textarea id="descricao" placeholder="DescriÃ§Ã£o (opcional)"></textarea>
      <select id="cliente">
        <option value="">Selecione um cliente</option>
      </select>
      <input type="date" id="dataInicio" placeholder="Data de InÃ­cio">
      <input type="date" id="dataEntrega" placeholder="Data de Entrega Estimada">

      <hr style="margin: 20px 0; border: none; border-top: 2px solid rgba(0,0,0,0.1);">
      <h3>Materiais Utilizados</h3>
      <div id="materiais"></div>
      <button type="button" class="btn outline" id="add-material">Adicionar Material</button>

      <p style="margin-top:20px;"><strong>Custo Total:</strong> <span id="custoTotal">R$ 0,00</span></p>

      <div class="form-actions">
        <button type="button" class="btn primary" id="salvarProjeto">CRIAR PROJETO +</button>
        <button type="button" class="btn outline" id="voltar">VOLTAR</button>
      </div>
    </div>
  </section>
</div>

<script>
  const API_BASE_PROJETOS = "http://localhost:8080/api/projetos";
  const API_BASE_CLIENTES = "http://localhost:8080/api/clientes";
  const API_BASE_MATERIAIS = "http://localhost:8080/api/materiais";

  let usuarioId = null;
  let materiais = [];
  let projetoEditId = localStorage.getItem("projetoEditId");

  document.addEventListener("DOMContentLoaded", async () => {
    usuarioId = Number(localStorage.getItem("sessionUserId"));
    if (!usuarioId) {
      alert("Ã‰ necessÃ¡rio efetuar o login antes de acessar o programa.");
      window.location.href = "home.html";
      return;
    }

    await carregarClientes();
    await carregarMateriais();

    if (projetoEditId) {
      await carregarProjetoParaEdicao(projetoEditId);
    }

    document.getElementById("add-material").addEventListener("click", adicionarMaterial);
    document.getElementById("salvarProjeto").addEventListener("click", salvarProjeto);
    document.getElementById("voltar").addEventListener("click", () => {
      localStorage.removeItem("projetoEditId");
      window.location.href = "projetos.html";
    });

    atualizarCustoTotal();
  });

  async function carregarClientes() {
    const select = document.getElementById("cliente");
    try {
      const resp = await fetch(`${API_BASE_CLIENTES}/${usuarioId}`);
      const clientes = await resp.json();
      console.log("Clientes carregados:", clientes);
      select.innerHTML = '<option value="">Selecione um cliente</option>';
      clientes.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
      });
    } catch (err) {
      console.error("Erro ao carregar clientes:", err);
    }
  }

  async function carregarMateriais() {
    try {
      const resp = await fetch(`${API_BASE_MATERIAIS}/${usuarioId}`);
      materiais = await resp.json();
      console.log("Materiais carregados:", materiais);
    } catch (err) {
      console.error("Erro ao carregar materiais:", err);
    }
  }

  async function carregarProjetoParaEdicao(id) {
    try {
      const resp = await fetch(`${API_BASE_PROJETOS}/${usuarioId}`);
      const projetos = await resp.json();
      const projeto = projetos.find(p => p.id == id);

      if (!projeto) {
        console.warn("Projeto nÃ£o encontrado:", id);
        return;
      }

      console.log("Projeto para ediÃ§Ã£o:", projeto);

      document.getElementById("titulo").value = projeto.titulo || "";
      document.getElementById("descricao").value = projeto.descricao || "";
      document.getElementById("cliente").value = projeto.cliente?.id || "";
      document.getElementById("dataInicio").value = projeto.dataInicio || "";
      document.getElementById("dataEntrega").value = projeto.dataEntregaEstimada || "";

      if (projeto.materiais && projeto.materiais.length > 0) {
        projeto.materiais.forEach(pm => {
          adicionarMaterialComDados(
            pm.material.id,
            pm.quantidade
          );
        });
      }

      document.getElementById("page-title").innerText = "Editar Projeto";
      document.getElementById("salvarProjeto").innerText = "ATUALIZAR PROJETO";

      window.history.replaceState({}, "", `projeto-form.html?id=${id}`);

      atualizarCustoTotal();

    } catch (err) {
      console.error("Erro ao carregar projeto para ediÃ§Ã£o:", err);
    }
  }

  function adicionarMaterial() {
    const container = document.getElementById("materiais");
    const div = document.createElement("div");
    div.classList.add("material-item");
    div.style.cssText = "display:flex;gap:10px;margin:10px 0;align-items:center;";
    div.innerHTML = `
      <select class="material-select" style="flex:2;padding:12px;border-radius:8px;border:1px solid #ddd;">
        <option value="">Selecione o material</option>
        ${materiais.map(m => `<option value="${m.id}" data-preco="${m.precoUnitario}">${m.nome} (${m.unidade})</option>`).join("")}
      </select>
      <input type="number" class="material-qtd" placeholder="Quantidade" min="0" step="any" style="flex:1;padding:12px;border-radius:8px;border:1px solid #ddd;">
      <button type="button" class="btn outline" onclick="removerMaterial(this)">Remover</button>
    `;
    container.appendChild(div);

    const selects = container.querySelectorAll(".material-select");
    const qts = container.querySelectorAll(".material-qtd");
    selects.forEach(s => s.addEventListener("change", atualizarCustoTotal));
    qts.forEach(q => q.addEventListener("input", atualizarCustoTotal));
  }

  function adicionarMaterialComDados(materialId, quantidade) {
    const container = document.getElementById("materiais");
    const div = document.createElement("div");
    div.classList.add("material-item");
    div.style.cssText = "display:flex;gap:10px;margin:10px 0;align-items:center;";
    div.innerHTML = `
      <select class="material-select" style="flex:2;padding:12px;border-radius:8px;border:1px solid #ddd;">
        <option value="">Selecione o material</option>
        ${materiais.map(m => `<option value="${m.id}" data-preco="${m.precoUnitario}" ${m.id == materialId ? 'selected' : ''}>${m.nome} (${m.unidade})</option>`).join("")}
      </select>
      <input type="number" class="material-qtd" placeholder="Quantidade" min="0" step="any" value="${quantidade}" style="flex:1;padding:12px;border-radius:8px;border:1px solid #ddd;">
      <button type="button" class="btn outline" onclick="removerMaterial(this)">Remover</button>
    `;
    container.appendChild(div);

    const selects = container.querySelectorAll(".material-select");
    const qts = container.querySelectorAll(".material-qtd");
    selects.forEach(s => s.addEventListener("change", atualizarCustoTotal));
    qts.forEach(q => q.addEventListener("input", atualizarCustoTotal));
  }

  function removerMaterial(btn) {
    btn.parentElement.remove();
    atualizarCustoTotal();
  }

  function atualizarCustoTotal() {
    let total = 0;
    document.querySelectorAll(".material-item").forEach(item => {
      const select = item.querySelector(".material-select");
      const qtd = parseFloat(item.querySelector(".material-qtd").value) || 0;
      const preco = parseFloat(select.selectedOptions[0]?.dataset.preco || 0);
      total += preco * qtd;
    });
    document.getElementById("custoTotal").innerText = `R$ ${total.toFixed(2)}`;
  }

  async function salvarProjeto() {
    const titulo = document.getElementById("titulo").value;
    const descricao = document.getElementById("descricao").value;
    const clienteId = Number(document.getElementById("cliente").value);
    const dataInicio = document.getElementById("dataInicio").value;
    const dataEntregaEstimada = document.getElementById("dataEntrega").value;

    const materiaisSelecionados = Array.from(document.querySelectorAll(".material-item")).map(item => {
      const materialId = Number(item.querySelector(".material-select").value);
      const quantidade = parseFloat(item.querySelector(".material-qtd").value) || 0;
      const material = materiais.find(m => m.id === materialId);
      return {
        material: { id: materialId },
        quantidade: quantidade,
        precoUnitarioSnapshot: material?.precoUnitario || 0,
        unidade: material?.unidade || "",
        observacao: ""
      };
    });

    const custoTotal = materiaisSelecionados.reduce(
      (acc, m) => acc + (m.precoUnitarioSnapshot * m.quantidade),
      0
    );

    const projeto = {
      usuario: { id: usuarioId },
      cliente: clienteId ? { id: clienteId } : null,
      titulo,
      descricao,
      custoTotal,
      dataInicio,
      dataEntregaEstimada,
      materiais: materiaisSelecionados
    };

    if (projetoEditId) {
      projeto.id = Number(projetoEditId);
    }

    console.log("Payload para POST /api/projetos:", projeto);

    try {
      const resp = await fetch(API_BASE_PROJETOS, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(projeto)
      });

      if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);

      localStorage.removeItem("projetoEditId");
      alert(projetoEditId ? "Projeto atualizado com sucesso!" : "Projeto salvo com sucesso!");
      window.location.href = "projetos.html";
    } catch (err) {
      console.error("Erro ao salvar projeto:", err);
      alert("Erro ao salvar projeto.");
    }
  }
</script>
</body>
</html>